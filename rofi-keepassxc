#!/bin/sh
# Copyright (c) 2020, samedamci <samedamci@disroot.org>
# Copyright (c) 2025, Andreas BÃ¶ttger  <andreas.boettger@tuhh.de>
# SPDX-License-Identifier: CC0-1.0, ISC
# All changes made since 12.12.2025 are dedicated to the public domain under CC0 1.0.
# See LICENSE-CC0.

rofi_menu() { rofi -normal-window -dmenu -markup -i "$@" ;}

# Wrapper for keepassxc-cli that injects the --yubikey option when provided
kxc() {
  if [ -z "$yk" ]; then
    keepassxc-cli "$@"
  else
    sub_command="$1"
    shift || true
    show_yubikey_prompt
    keepassxc-cli "${sub_command}" --yubikey "$yk" "$@"
    hide_yubikey_prompt
  fi
}

require_value() {
  # Usage: require_value "Prompt" [rofi args...]
  value="$(rofi_menu -p "$1" -l 0 "$@")" || exit 1
  [ -z "$value" ] && exit 1
  printf "%s" "$value"
}

kxc_with_pass() {
  # Keeps all keepassxc-cli calls consistent and easy to spot.
  echo "$dbpass" | kxc "$@"
}

show_yubikey_prompt() {
  # Show a visible hint while keepassxc-cli is waiting for YubiKey touch.
  # Only when yubikey mode is enabled.
  yk_prompt_pid=""
  [ -z "$yk" ] && return 0
  rofi -markup -e "Please present or touch your YubiKey to continue." &
  yk_prompt_pid="$!"
}

hide_yubikey_prompt() {
  [ -n "$yk_prompt_pid" ] || return 0
  kill "$yk_prompt_pid" 2>/dev/null || true
  yk_prompt_pid=""
}

element_has() {
  # Checks whether the current $element contains the given label (e.g. "Title: ").rofi -e
  printf "%s" "$element" | grep -qF "$1"
}

clip_from_element() {
  # Usage: clip_from_element <prefix_length_to_drop>
  printf "%s" "$element" | cut -b "$1"- | xclip -sel clip
}

ask_yes_no_flag() {
  # Usage: ask_yes_no_flag "Prompt" "-flag" [rofi args...]
  answer="$(printf "Yes\nNo" | rofi_menu -p "$1" -l 2 "$@")" || exit 1
  case "$answer" in
    Yes) printf "%s" "$2" ;;
    No)  printf "%s" "" ;;
    *)   exit 1 ;;
  esac
}

clip_username() {
  kxc_with_pass show "$db" "$entry" | grep -F 'UserName:' | cut -b 11- | xclip -sel clip
}
clip_password() { kxc_with_pass clip "$db" "$entry" "$timeout" ;}
clip_title() { clip_from_element 8 ;}
clip_url() { clip_from_element 6 ;}
clip_notes() { clip_from_element 8 ;}

generate_password() {
  char_num="$(require_value "Number of password characters" )"
  numbers="$(ask_yes_no_flag "Use numbers?" "-n" )"
  special="$(ask_yes_no_flag "Use special characters?" "-s" )"
  ext_ascii="$(ask_yes_no_flag "Use extended ASCII?" "-e" )"
}

clip_element() {
  case "$element" in
    Title:\ *)    clip_title ;;
    UserName:\ *) clip_username ;;
    Password:\ *) clip_password ;;
    URL:\ *)      clip_url ;;
    Notes:\ *)    clip_notes ;;
  esac
}

edit_element() {
  case "$element" in
    Title:\ *)
      new_title="$(require_value "Enter new entry title" )"
      kxc_with_pass edit -t "$new_title" "$db" "$entry"
      ;;
    UserName:\ *)
      new_username="$(require_value "Enter new entry username" )"
      kxc_with_pass edit -u "$new_username" "$db" "$entry"
      ;;
    Password:\ *)
      action="$(printf "Enter password\nGenerate password" | rofi_menu -p "Choose action" -l 2 )" || exit 1
      case "$action" in
        "Enter password")
          new_password="$(rofi_menu -no-plugins -p "Enter new entry password" -l 0 -password)" || exit 1
          [ -z "$new_password" ] && exit 1
          printf "%s" "$dbpass\n$new_password" | kxc edit -p "$db" "$entry"
          ;;
        "Generate password")
          generate_password
          kxc_with_pass edit -g -L "$char_num $numbers$special$ext_ascii" --exclude-similar "$db" "$entry"
          ;;
      esac
      ;;
    URL:\ *)
      new_url="$(require_value "Enter new entry URL" )"
      kxc_with_pass edit --url "$new_url" "$db" "$entry"
      ;;
    Notes:\ *)
      rofi -e "You cannot edit notes for entries now."
      ;;
  esac
}

show_entry_info() {
  element="$(kxc_with_pass show "$db" "$entry" | grep -Ev 'Enter|?*/' | rofi_menu -p "Info" -l 7 )"
  [ "$element" ] && action="$(printf "Clip\nEdit" | rofi_menu -p "Choose action" -l 2)"
  case "$action" in
    Clip) clip_element ;;
    Edit) edit_element ;;
  esac
}

delete_entry() {
  kxc_with_pass rm "$db" "$entry"
  rofi -e "Deleted \"$entry\" entry"
}

add_entry() {
  if [ "$entry" ]; then
    action="$(printf "Yes\nNo" | rofi_menu -p "Add \"$entry\" entry?" -l 2 )"
    case "$action" in
      Yes)
        username="$(require_value "Enter entry username" )"
        action="$(printf "Enter password\nGenerate password" | rofi_menu -p "Choose action" -l 2 )"
        [ -z "$action" ] && exit 1
        ;;
      *) exit ;;
    esac
  else
    exit
  fi

  case "$action" in
    "Enter password")
      password="$(rofi_menu -no-plugins -p "Enter new entry password" -l 0 -password )" || exit 1
      [ -z "$password" ] && exit 1
      printf "%s" "$dbpass\n$password" | kxc add "$db" "$entry" -u "$username" -p
      ;;
    "Generate password")
      generate_password
      kxc_with_pass add "$db" "$entry" -u "$username" -g -L "$char_num $numbers$special$ext_ascii"
      rofi -e "Successfully added \"$entry\" entry"
      ;;
    *) exit ;;
  esac
}

choose_action() {
  [ "$entry" ] && action="$(printf "Clip username\nClip password\nShow info\nDelete" | \
    rofi_menu -p "Choose action for \"$entry\" entry" -l 4 )"
  case "$action" in
    "Clip username") clip_username ;;
    "Clip password") clip_password ;;
    "Show info") show_entry_info ;;
    Delete) delete_entry ;;
  esac
}

print_help() {
  printf "usage: rofi-keepassxc [-h] [-d] [-y] [-t]

  arguments:
  -h, --help                     show this help message and exit
  -d, --database [file]          specify keepass database file path
  -y, --yubikey <slot[:serial]>  YubiKey slot and optional serial used to
                                 access the database (e.g., 1:7370001).
  -t, --timeout [value]          specify a timeout in seconds for clipped password; default to 15 seconds\n\n"
}

[ ! "$1" ] && { print_help; exit ;}
while [ "$1" ]; do
  case "$1" in
    -h | --help) print_help; exit;;
    -d | --database) db="$2"; shift; shift;;
    -y | --yubikey) yk="$2"; shift; shift;;
    -t | --timeout) timeout="$2"; shift; shift;;
    *) echo "[E] Invalid argument."; exit 1;;
  esac
done

[ ! "$timeout" ] && timeout=15
CACHE=$HOME/.cache/rofi-keepassxc/
mkdir -p "$CACHE"

tmp="$CACHE/tmp"
err="$CACHE/err"
trap 'rm -f "$tmp" "$err"' EXIT INT TERM

dbpass="$(rofi_menu -no-plugins -p "Enter password" -mesg "to unlock: <b>$db</b>" -l 0 -password )"
[ -z "$dbpass" ] && exit 1

# Instead of validating with an extra command (which would require an extra YubiKey touch),
# build the entry list once and treat failure as validation failure.
if ! kxc_with_pass ls --recursive --flatten "$db" 2>"$err" \
  | grep -Fv -e 'Enter' -e '?*/' \
  | grep -Fv -e 'Recycle Bin' -e 'Recycle Bin/' \
  | grep -vE '/$' \
  | sort >"$tmp"; then
  rofi -e "Failed to open database (wrong password, missing file, or YubiKey issue)."
  exit 1
fi

while :; do
  elements_num=$(
    if [ "$(wc -l < "$tmp")" -gt 20 ]
    then
      echo 20
    else
      wc -l < "$tmp"
    fi
  )

  entry="$(rofi_menu -p "Entry list" -l "$elements_num" < "$tmp")"
  [ -z "$entry" ] && exit 0

  if ! grep -Fxq -- "$entry" "$tmp"; then
    add_entry || exit 1

    # Update local list (avoid extra keepassxc-cli ls -> avoids extra YubiKey touch)
    printf "%s\n" "$entry" >>"$tmp"
    sort -u -o "$tmp" "$tmp"
    continue
  fi

  # Fetch full entry once (may trigger one YubiKey touch)
  entry_data="$(kxc_with_pass show "$db" "$entry")" || { rofi -e "Failed to read entry"; continue; }

  while :; do
    echo "Choose action for \"$entry\" entry"
    action="$(printf "Clip username\nClip password\nShow info\nDelete\nBack" | \
      rofi_menu -p "Choose action for \"$entry\" entry" -l 5 )" || break

    case "$action" in
      "Clip username")
        printf "%s" "$entry_data" | grep -F 'UserName:' | cut -b 11- | xclip -sel clip
        ;;
      "Clip password")
        kxc_with_pass clip "$db" "$entry" "$timeout"
        ;;
      "Show info")
        show_info_for="$entry_data"
        ;;
      Delete)
        delete_entry

        # Update local list (avoid extra keepassxc-cli ls -> avoids extra YubiKey touch)
        grep -Fxv -- "$entry" "$tmp" >"$tmp.new" && mv "$tmp.new" "$tmp"
        break
        ;;
      Back)
        break
        ;;
    esac
    if [ -n "$show_info_for" ]; then
      while :; do
        echo "Show Info for \"$show_info_for\" entry"
        action="$(printf "%s\nBack" "$show_info_for" | \
          rofi_menu -p "Info" -l 8 )" || break

        case "$action" in
          Back)
            break
            ;;
        esac
      done
    fi
  done
done

