#!/bin/sh
# Copyright (c) 2025, aboettger-tuhh
# SPDX-License-Identifier: CC0-1.0
# This file is dedicated to the public domain under CC0 1.0.
# See LICENSE-CC0.

set -eu

rofi_menu() { rofi -dmenu -i "$@"; }

LABELS_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/rofi-secretservice/labels"
TIMEOUT_SECONDS=15

need_cmd() {
  command -v "$1" >/dev/null 2>&1 || {
    rofi -e "Missing dependency: $1"
    exit 1
  }
}

need_cmd rofi
need_cmd secret-tool
need_cmd xclip

[ -f "$LABELS_FILE" ] || { rofi -e "Missing labels file:\n$LABELS_FILE"; exit 1; }

label="$(rofi_menu -p "Label" -l 15 <"$LABELS_FILE")" || exit 1
[ -n "$label" ] || exit 0

field="$(printf "username\npassword\nurl\nnotes\n" | rofi_menu -p "Field" -l 4)" || exit 1
[ -n "$field" ] || exit 0

value="$(secret-tool lookup label "$label" field "$field" 2>/dev/null || true)"
[ -n "$value" ] || { rofi -e "No secret found for:\n$label / $field"; exit 1; }

printf "%s" "$value" | xclip -selection clipboard

if [ "$field" = "password" ]; then
  ( sleep "$TIMEOUT_SECONDS"; printf "" | xclip -selection clipboard ) >/dev/null 2>&1 &
  rofi -e "Copied $label / $field (clears in ${TIMEOUT_SECONDS}s)"
else
  rofi -e "Copied $label / $field"
fi